<div class="container">
  <div class="row">
    <h1 class="text-center"><%= @campaign.title %>
    <%= link_to edit_campaign_path(@campaign), class:"edit-icon" do%>
      <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
    <% end %>
    <h3 class="text-center"><%= @campaign.company.name %></h3>
    <h2 class="text-center"><%= humanized_money_with_symbol(@total) %></h2>
    <br>

    <ul class="list-unstyled">
      <% @campaign.orders.each do |order| %>
        <li data-order-id='<%= order.id %>'>
          <div class="col-md-6 col-md-offset-3">
            <h4><%= order.panel.panel_type.name %></h4>
            <p><strong>Estação: </strong>
              <%= order.panel.station.name %>
            </p>
            <p><strong>Data de veículação: </strong>
              <%= order.date.to_date.strftime("%d/%m/%Y") %>
            </p>
            <p>
              <strong>Duração: </strong>
              <%= order.duration %> dias
            </p>
            <p>
              <strong>Válido até: </strong>
              <%= (order.date.to_date + order.duration).to_date.strftime("%d/%m/%Y")%>
            </p>
            <p>
              <strong>Área Total: </strong>
              <%= order.panel.panel_type.total_area %>
            </p>
            <p>
              <strong>Total: </strong>
              <%= humanized_money_with_symbol(order.price) %>
            </p>
            <%= link_to "Delete order", order_path(order), method: :delete, remote: true %>
          </div>
        </li>
      <% end %>
      <button class="btn btn-primary" id="pay-button">Finalizar compra</button>

      <script>
      var button = document.querySelector('#pay-button');
      button.addEventListener('click', function() {
        // inicia a instância do Checkout
        var checkout = new PagarMeCheckout.Checkout({
          encryption_key: 'ek_test_haQ07HnJq4J4TgMhPKUvUymJPksG69',
          success: function(data) {
            console.log(data);
          },
          error: function(err) {
            console.log(err);
          },
          close: function() {
            console.log('The modal has been closed.');
          }
        });

        // Obs.: é necessário passar os valores boolean como string
        checkout.open({
          amount: <%= @total_cents %>,
          buttonText: 'Pagar',
          buttonClass: 'botao-pagamento btn-primary',
          customerData: 'false',
          createToken: 'true',
          maxInstallments: 6,
          paymentMethods: 'credit_card, boleto',
          customer: {
            external_id: '<%= @campaign.company.id %>',
            name: '<%= @campaign.company.name %>',
            type: 'individual',
            country: 'br',
            email: '<%= current_user.email %>',
            documents: [
              {
                type: 'cpf',
                number: '<%= current_user.cpf %>'
              },
              {
                type: 'cnpj',
                number: '<%= @campaign.company.cnpj %>'
              }
            ],
            phone_numbers: ['<%= j current_user.phone_number %>'],
          },
          defaultInstallment: 1,
          billing: {
            name: '<%= @campaign.company.name %>',
            address: {
              country: 'br',
              state: '<%= @campaign.company.state %>',
              city: '<%= @campaign.company.city %>',
              neighborhood: '<%= @campaign.company.address2 %>',
              street: '<%= @campaign.company.address1 %>',
              street_number: '<%= @campaign.company.street_number %>',
              zipcode: '<%= @campaign.company.zip_code.tr('-', '') %>'
            }
          },
          items: <%= raw @orders.to_json %>
        });
      });
      </script>
    </ul>
  </div>
</div>
